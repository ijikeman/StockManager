<div>
  <div class="page-header">
    <h1 class="page-title">損益一覧</h1>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-container">
    <div class="tab-buttons">
      <button 
        class="tab-button" 
        :class="{ active: activeTab === 'unrealized' }"
        @click="setActiveTab('unrealized')">
        含み損益（未実現）
      </button>
      <button 
        class="tab-button" 
        :class="{ active: activeTab === 'realized' }"
        @click="setActiveTab('realized')">
        確定損益（実現済み）
      </button>
    </div>
  </div>

  <!-- Unrealized Profit/Loss Tab -->
  <div v-if="activeTab === 'unrealized'">
    <!-- Summary Section for Unrealized -->
    <div class="summary-section" v-if="unrealizedData && unrealizedData.length > 0">
      <div class="summary-card">
        <h3>含み損益サマリー</h3>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">配当金合計:</span>
            <span class="summary-value positive">{{ fmtIncoming(unrealizedSummary.totalIncoming) }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">優待金合計:</span>
            <span class="summary-value positive">{{ fmt(unrealizedSummary.totalBenefit) }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">株式損益合計:</span>
            <span class="summary-value" :class="unrealizedSummary.totalEvaluation >= 0 ? 'positive' : 'negative'">
              {{ fmt(unrealizedSummary.totalEvaluation) }}
            </span>
          </div>
          <div class="summary-item total">
            <span class="summary-label">総損益:</span>
            <span class="summary-value" :class="unrealizedSummary.totalProfitLoss >= 0 ? 'positive' : 'negative'">
              {{ fmt(unrealizedSummary.totalProfitLoss) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <label>
        オーナー:
        <select v-model="filterOwner" class="filter-select">
          <option value="">すべて</option>
          <option v-for="owner in uniqueOwners" :key="owner" :value="owner">
            {{ owner }}
          </option>
        </select>
      </label>
    </div>

    <!-- Unrealized Data Table -->
    <table class="common-table profit-loss-table" v-if="filteredUnrealizedItems.length > 0">
      <thead>
        <tr>
          <th class="sortable-header" @click="sortUnrealizedBy('stockCode')">
            銘柄コード
            <span class="sort-indicator" :class="{ active: unrealizedSortBy === 'stockCode' }">
              {{ unrealizedSortBy === 'stockCode' ? (unrealizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortUnrealizedBy('stockName')">
            銘柄名
            <span class="sort-indicator" :class="{ active: unrealizedSortBy === 'stockName' }">
              {{ unrealizedSortBy === 'stockName' ? (unrealizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortUnrealizedBy('buyTransactionDate')">
            購入日
            <span class="sort-indicator" :class="{ active: unrealizedSortBy === 'buyTransactionDate' }">
              {{ unrealizedSortBy === 'buyTransactionDate' ? (unrealizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortUnrealizedBy('purchasePrice')">
            購入単価
            <span class="sort-indicator" :class="{ active: unrealizedSortBy === 'purchasePrice' }">
              {{ unrealizedSortBy === 'purchasePrice' ? (unrealizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortUnrealizedBy('currentPrice')">
            現在価格
            <span class="sort-indicator" :class="{ active: unrealizedSortBy === 'currentPrice' }">
              {{ unrealizedSortBy === 'currentPrice' ? (unrealizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortUnrealizedBy('currentUnit')">
            保有単元数
            <span class="sort-indicator" :class="{ active: unrealizedSortBy === 'currentUnit' }">
              {{ unrealizedSortBy === 'currentUnit' ? (unrealizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortUnrealizedBy('totalIncoming')">
            総配当金
            <span class="sort-indicator" :class="{ active: unrealizedSortBy === 'totalIncoming' }">
              {{ unrealizedSortBy === 'totalIncoming' ? (unrealizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortUnrealizedBy('totalBenefit')">
            総優待金
            <span class="sort-indicator" :class="{ active: unrealizedSortBy === 'totalBenefit' }">
              {{ unrealizedSortBy === 'totalBenefit' ? (unrealizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortUnrealizedBy('evaluationProfitloss')">
            株式損益
            <span class="sort-indicator" :class="{ active: unrealizedSortBy === 'evaluationProfitloss' }">
              {{ unrealizedSortBy === 'evaluationProfitloss' ? (unrealizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="item in filteredUnrealizedItems" :key="`${item.stockCode}`" :class="{ 'nisa-row': item.isNisa }">
          <td>{{ item.stockCode }}</td>
          <td>{{ item.stockName }}</td>
          <td>{{ item.buyTransactionDate || '-' }}</td>
          <td class="price-cell">{{ fmtPrice(item.purchasePrice) }}</td>
          <td class="price-cell">{{ item.currentPrice ? fmtPrice(item.currentPrice) : '-' }}</td>
          <td class="text-center">{{ item.currentUnit || 0 }}</td>
          <td class="price-cell positive">{{ fmtIncoming((item.totalIncoming * item.currentUnit * item.minimalUnit) || 0) }}</td>
          <td class="price-cell positive">{{ fmt(item.totalBenefit * item.currentUnit * item.minimalUnit || 0) }}</td>
          <td class="price-cell" :class="calculateEvaluation(item) >= 0 ? 'positive' : 'negative'">
            {{ fmt(calculateEvaluation(item)) }}
          </td>
        </tr>
      </tbody>
    </table>
    <div v-else>
      <p>データはありません</p>
    </div>
  </div>

  <!-- Realized Profit/Loss Tab -->
  <div v-if="activeTab === 'realized'">
    <!-- Summary Section for Realized -->
    <div class="summary-section" v-if="realizedData && realizedData.length > 0">
      <div class="summary-card">
        <h3>確定損益サマリー</h3>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">取引件数:</span>
            <span class="summary-value">{{ realizedSummary.count }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">配当金合計:</span>
            <span class="summary-value positive">{{ fmtIncoming(realizedSummary.totalIncoming) }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">優待金合計:</span>
            <span class="summary-value positive">{{ fmt(realizedSummary.totalBenefit) }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">株式損益合計:</span>
            <span class="summary-value" :class="realizedSummary.totalEvaluation >= 0 ? 'positive' : 'negative'">
              {{ fmt(realizedSummary.totalEvaluation) }}
            </span>
          </div>
          <div class="summary-item total">
            <span class="summary-label">総確定損益:</span>
            <span class="summary-value" :class="realizedSummary.totalProfitLoss >= 0 ? 'positive' : 'negative'">
              {{ fmt(realizedSummary.totalProfitLoss) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <label>
        オーナー:
        <select v-model="filterOwner" class="filter-select">
          <option value="">すべて</option>
          <option v-for="owner in uniqueOwners" :key="owner" :value="owner">
            {{ owner }}
          </option>
        </select>
      </label>
    </div>

    <!-- Realized Data Table -->
    <table class="common-table profit-loss-table" v-if="filteredRealizedItems.length > 0">
      <thead>
        <tr>
          <th class="sortable-header" @click="sortRealizedBy('stockCode')">
            銘柄コード
            <span class="sort-indicator" :class="{ active: realizedSortBy === 'stockCode' }">
              {{ realizedSortBy === 'stockCode' ? (realizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortRealizedBy('stockName')">
            銘柄名
            <span class="sort-indicator" :class="{ active: realizedSortBy === 'stockName' }">
              {{ realizedSortBy === 'stockName' ? (realizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortRealizedBy('buyTransactionDate')">
            購入日
            <span class="sort-indicator" :class="{ active: realizedSortBy === 'buyTransactionDate' }">
              {{ realizedSortBy === 'buyTransactionDate' ? (realizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortRealizedBy('purchasePrice')">
            購入単価
            <span class="sort-indicator" :class="{ active: realizedSortBy === 'purchasePrice' }">
              {{ realizedSortBy === 'purchasePrice' ? (realizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortRealizedBy('sellTransactionDate')">
            売却日
            <span class="sort-indicator" :class="{ active: realizedSortBy === 'sellTransactionDate' }">
              {{ realizedSortBy === 'sellTransactionDate' ? (realizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortRealizedBy('sellPrice')">
            売却単価
            <span class="sort-indicator" :class="{ active: realizedSortBy === 'sellPrice' }">
              {{ realizedSortBy === 'sellPrice' ? (realizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortRealizedBy('sellUnit')">
            売却単元数
            <span class="sort-indicator" :class="{ active: realizedSortBy === 'sellUnit' }">
              {{ realizedSortBy === 'sellUnit' ? (realizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortRealizedBy('profitLoss')">
            株式損益
            <span class="sort-indicator" :class="{ active: realizedSortBy === 'profitLoss' }">
              {{ realizedSortBy === 'profitLoss' ? (realizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortRealizedBy('totalIncoming')">
            総配当金
            <span class="sort-indicator" :class="{ active: realizedSortBy === 'totalIncoming' }">
              {{ realizedSortBy === 'totalIncoming' ? (realizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortRealizedBy('totalBenefit')">
            総優待金
            <span class="sort-indicator" :class="{ active: realizedSortBy === 'totalBenefit' }">
              {{ realizedSortBy === 'totalBenefit' ? (realizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
          <th class="sortable-header" @click="sortRealizedBy('totalProfitLoss')">
            確定損益
            <span class="sort-indicator" :class="{ active: realizedSortBy === 'totalProfitLoss' }">
              {{ realizedSortBy === 'totalProfitLoss' ? (realizedSortOrder === 'asc' ? '▲' : '▼') : '▲▼' }}
            </span>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(item, index) in filteredRealizedItems" :key="`${item.stockCode}-${item.sellTransactionDate}-${index}`" :class="{ 'nisa-row': item.isNisa }">
          <td>{{ item.stockCode }}</td>
          <td>{{ item.stockName }}</td>
          <td>{{ item.buyTransactionDate || '-' }}</td>
          <td class="price-cell">{{ fmtPrice(item.purchasePrice) }}</td>
          <td>{{ item.sellTransactionDate || '-' }}</td>
          <td class="price-cell">{{ item.sellPrice ? fmtPrice(item.sellPrice) : '-' }}</td>
          <td class="text-center">{{ item.sellUnit || '-' }}</td>
          <td class="price-cell" :class="(item.profitLoss || 0) >= 0 ? 'positive' : 'negative'">
            {{ item.profitLoss ? fmt(item.profitLoss) : '-' }}
          </td>
          <td class="price-cell positive">{{ fmtIncoming((item.totalIncoming * item.sellUnit * item.minimalUnit) || 0) }}</td>
          <td class="price-cell positive">{{ fmt((item.totalBenefit * item.sellUnit * item.minimalUnit) || 0) }}</td>
          <td class="price-cell" :class="((item.profitLoss || 0) + (item.totalIncoming * item.sellUnit * item.minimalUnit || 0) + (item.totalBenefit * item.sellUnit * item.minimalUnit || 0)) >= 0 ? 'positive' : 'negative'">
            {{ fmt((item.profitLoss || 0) + (item.totalIncoming * item.sellUnit * item.minimalUnit || 0) + (item.totalBenefit * item.sellUnit * item.minimalUnit || 0)) }}
          </td>
        </tr>
      </tbody>
    </table>
    <div v-else>
      <p>データはありません</p>
    </div>
  </div>
</div>
